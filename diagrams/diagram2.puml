@startuml
skinparam dpi 90
skinparam componentStyle rectangle
skinparam shadowing false
skinparam linetype ortho
skinparam ArrowColor black

' Icons
!define CLOUD(x) node x <<cloud>>
!define DEVICE(x) artifact x <<device>>
!define SERVER(x) component x <<server>>
!define DB(x) database x <<db>>

' ----------------------------
' LAYOUT – VERTICAL STACK
' ----------------------------

' === TOP: EXTERNAL CLIENTS ===
frame "External Clients" as ClientsGroup #FFFFFF {
  CLOUD(ClientWireless) #F2F2F2
  CLOUD(ClientWired)    #F2F2F2
}

' === CENTRAL HOST ===
rectangle "Central Host Machine" as CentralHost #DDEBF7 {

  ' Web + Server inside same binary
  rectangle "Server Binary" as ServerBin #fcca03 {
      SERVER(ServerComponent) #FFF6D1
      SERVER(WebComponent)    #FCE5A4
  }

  ' Proxy on same machine, separate process
  SERVER(Proxy) #FFF2CC

  ' DB Layer (intermediate connector)
  DB(DBLayer) #E6F2E6
}

' Actual Postgres (external)
DB(Postgres) #D9E1F2

' === REMOTE SITES ===
' VLAN A
frame "Remote VLAN A (Local Segment)" as SiteA #FFF4E0 {
    CLOUD(ProbeA) #FFE6CC
    DEVICE(DeviceA) #FFF4E0
}

' VLAN B
frame "Remote VLAN B (Local Segment)" as SiteB #FFF4E0 {
    CLOUD(ProbeB) #FFE6CC
    DEVICE(DeviceB) #FFF4E0
}

' ----------------------------
' CONNECTIONS (unchanged)
' ----------------------------

' Web <-> Server (no labels)
ServerComponent -[#918df7,thickness=3]- WebComponent

' Device -> Probe (mDNS capture)
DeviceA -[#1F77B4,thickness=2]- ProbeA
DeviceB -[#1F77B4,thickness=2]- ProbeB

' Probe <-> Server (Encapsulated mDNS + Control)
ProbeA -[#1F77B4,thickness=2]- ServerComponent
ProbeB -[#1F77B4,thickness=2]- ServerComponent

ProbeA -[#918df7,thickness=2]- ServerComponent
ProbeB -[#918df7,thickness=2]- ServerComponent

' Server -> DB Layer -> Postgres
ServerBin -[#cf97b2,thickness=2]- DBLayer
DBLayer -[#cf97b2,thickness=2]- Postgres

' Server -> Proxy configuration
ServerComponent -[#ebd810,thickness=2]- Proxy

' mDNS retransmit -> clients
ServerComponent -[#2CA02C,thickness=2]- ClientWireless
ServerComponent -[#2CA02C,thickness=2]- ClientWired

' Direct data traffic segment A
ClientWired -[#C62828,thickness=3]- DeviceA

' Proxied data traffic segment B
ClientWireless -[#8E44AD,thickness=3]- Proxy
Proxy -[#8E44AD,thickness=3]- DeviceB


' ----------------------------
' LEGEND
' ----------------------------
legend left
  <b>Legend</b>
  <color:#1F77B4><b>Blue</b></color>: Captured mDNS (Device → Probe)
  <color:#918df7><b>Purple</b></color>: Control channels
  <color:#cf97b2><b>Pink</b></color>: DB/Storage
  <color:#2CA02C><b>Green</b></color>: mDNS retransmission to clients
  <color:#C62828><b>Red</b></color>: Direct client-to-device data
  <color:#8E44AD><b>Violet</b></color>: Proxied data traffic
endlegend

@enduml
