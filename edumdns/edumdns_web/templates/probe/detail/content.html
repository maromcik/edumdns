<div class="2xl:w-5/6 w-full mx-auto px-4 sm:px-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-4xl font-semibold text-sat-xl flex items-center gap-2">
            <span id="probe-status-dot" class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
            Probe {% if probe.name is none %}{{ probe.id[:13] }}...{% else %}{{ probe.name }}{% endif %}
        </h1>
    </div>

    <div class="flex items-center gap-2 mb-6">
        <div class="flex items-center gap-2">
            <a href="/probe"
               class="flex items-center justify-center w-10 h-10 rounded-md border border-base bg-cards text-lg font-medium text-acc hover:text-acc-xl transition-colors">
                ←
            </a>
            {% if permissions|has_perm("Reconnect") %}
            <button
                    class="bg-yellow-400 hover:bg-yellow-500 flex items-center justify-center w-10 h-10  rounded-md text-button shadow-md"
                    hx-get="/probe/{{ probe.id }}/reconnect"
                    hx-target="#probe-content-area"
                    hx-target-error="#probe-content-area"
                    hx-push-url="/probe/{{ probe.id }}"
                    title="Reconnect probe"
            >
                <i class="fa-solid fa-rotate-right"></i>
            </button>
            {% endif %}
            {% if probe.adopted and permissions|has_perm("Forget") %}
            <button
                    class="bg-purple-400 hover:bg-purple-500 items-center justify-center w-10 h-10  rounded-md text-button shadow-md"
                    hx-get="/probe/{{ probe.id }}/forget"
                    hx-target="#probe-content-area"
                    hx-target-error="#probe-content-area"
                    hx-push-url="/probe/{{ probe.id }}"
                    title="Stop (forget) probe"
            >
                <i class="fa-solid fa-stop"></i>
            </button>
            {% endif %}
            {% if not probe.adopted and permissions|has_perm("Adopt") %}
            <button
                    class="bg-green-400 hover:bg-green-500 items-center justify-center w-10 h-10  rounded-md text-button shadow-md"
                    hx-get="/probe/{{ probe.id }}/adopt"
                    hx-target="#probe-content-area"
                    hx-target-error="#probe-content-area"
                    hx-push-url="/probe/{{ probe.id }}"
                    title="Resume (adopt) probe"
            >
                <i class="fa-solid fa-play"></i>
            </button>
            {% endif %}
            {% if permissions|has_perm("Delete") %}
            <button
                    class="bg-red-600 hover:bg-red-700 items-center justify-center w-10 h-10  rounded-md text-button shadow-md"
                    hx-delete="/probe/{{ probe.id }}/delete"
                    hx-confirm="Delete this probe? All devices and related packets will be removed."
                    hx-target="#probe-content-area"
                    hx-target-error="#probe-content-area"
                    hx-push-url="/probe"
                    title="Permanently delete probe"
            >
                <i class="fa-solid fa-trash"></i>
            </button>
            {% endif %}
            {% if permissions|has_perm("Create") %}
            <button
                    class="bg-acc hover:bg-acc-xl items-center justify-center w-10 h-10  rounded-md text-button shadow-md"
                    hx-get="/device/create/{{ probe.id}}"
                    hx-target="#probe-content-area"
                    hx-target-error="#probe-content-area"
                    hx-push-url="/device/create/{{ probe.id}}"
                    title="Add a new device"
            >
                <i class="fa-solid fa-plus"></i>
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Probe Card -->
    <div class="rounded-lg border border-base bg-cards p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <!-- ID -->
            <div class="flex flex-col">
                <span class="text-xs uppercase tracking-wide text-sat-m">ID</span>
                <span class="font-mono text-code"><code>{{ probe.id }}</code></span>
            </div>

            <div class="flex flex-col">
                <span class="text-xs uppercase tracking-wide text-sat-m">Owner</span>
                <span id="owner-field" class="font-mono text-code flex items-center gap-2">
                    {% if probe.owner_id is none %}
                      <span class="text-muted-foreground text-sat-m">—</span>
                    {% else %}
                      <a href="/user/{{ probe.owner_id }}" id="owner-link">{{ probe.owner_id }}</a>
                    {% endif %}
                    {% if user.user.admin %}
                      <button
                              id="edit-owner-btn"
                              class="text-xs text-acc hover:text-acc-xl"
                              title="Edit owner"
                              type="button"
                      >
                        <i class="fa-solid fa-pen"></i>
                      </button>
                    {% endif %}
                </span>
            </div>

            <!-- MAC -->
            <div class="flex flex-col">
                <span class="text-xs uppercase tracking-wide text-sat-m">MAC</span>
                <span class="font-mono text-code"><code>{{ probe.mac }}</code></span>
            </div>

            <!-- IP -->
            <div class="flex flex-col">
                <span class="text-xs uppercase tracking-wide text-sat-m">IP</span>
                <span class="font-mono text-code"><code>{{ probe.ip }}</code></span>
            </div>


            <!-- TIME -->
            <div class="flex flex-col">
                <span class="text-xs uppercase tracking-wide text-sat-m">First connected at</span>
                <span class="text-sat-l">{{ probe.first_connected_at }}</span>
            </div>

            <div class="flex flex-col">
                <span class="text-xs uppercase tracking-wide text-sat-m">Last connected at</span>
                <span class="text-sat-l">{{ probe.last_connected_at }}</span>
            </div>

            <!-- Adopted -->
            <div class="flex flex-col">
                <span class="text-xs uppercase tracking-wide text-sat-m">Adopted</span>
                <span class="font-mono text-sat-xl">
          {% if probe.adopted %}
            <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
          {% else %}
            <span class="inline-flex items-center rounded-md bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">No</span>
          {% endif %}
        </span>
            </div>

        </div>
    </div>
    <!-- Make these fields editable -->
    <div class="rounded-lg border border-base bg-cards p-6 mb-8">
        <h3 class="text-2xl font-medium mb-4 text-sat-l">Probe Settings</h3>
        <form
                method="post"
                hx-post="/probe/update"
                hx-target="#probe-content-area"
                hx-target-error="#probe-content-area"
                class="grid grid-cols-1 md:grid-cols-2 gap-4"
        >
            <input type="hidden" id="probe_id" name="id" value="{{ probe.id }}"/>

            <!-- Name -->
            <div class="flex flex-col">
                <label for="name" class="text-xs uppercase tracking-wide text-sat-m">Name</label>
                <input
                        id="name"
                        name="name"
                        type="text"
                        value="{% if probe.name is none %}{% else %}{{ probe.name }}{% endif %}"
                        placeholder="Friendly name"
                        class="mt-1 rounded-md border border-base bg-panes px-3 py-2 text-sat-l focus:outline-none focus:ring-2 focus:ring-acc"
                />
                <p class="text-xs text-sat-m mt-1">Optional friendly name for the probe.</p>
            </div>

            <!-- pre_shared_key -->
            <div class="flex flex-col">
                <label for="pre_shared_key" class="text-xs uppercase tracking-wide text-sat-m">Pre-Shared Secret
                    Key</label>
                <input
                        id="pre_shared_key"
                        name="pre_shared_key"
                        type="text"
                        value="{% if probe.pre_shared_key is none %}{% else %}{{ probe.pre_shared_key }}{% endif %}"
                        placeholder="Optional pre-shared key"
                        class="mt-1 rounded-md border border-base bg-panes px-3 py-2 text-sat-l focus:outline-none focus:ring-2 focus:ring-acc"
                />
                <p class="text-xs text-sat-m mt-1">Optional Pre-Shared Key for increased security (probe traffic is
                    encrypted nonetheless).</p>
            </div>

            {% if permissions|has_perm("Update") %}
            <!-- Actions -->
            <div class="md:col-span-2 flex items-center gap-2 pt-2">
                <button
                        type="submit"
                        class="inline-flex items-center rounded-md text-button bg-acc px-4 py-2 text-sm font-medium transition-colors"
                >
                    Save
                </button>
                <button
                        type="reset"
                        class="inline-flex items-center rounded-md text-button bg-acc-l px-4 py-2 text-sm font-medium transition-colors"
                >
                    Reset
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Permissions Table -->
    {% if user.user.admin %}
    <div class="max-w-7xl overflow-x-auto rounded-lg border border-base bg-cards mb-8">
        <div class="flex flex-col justify-center items-center py-4">
            <h2 class="text-3xl font-medium text-sat-xl">Permissions</h2>
        </div>
        <div class="max-w-7xl overflow-x-auto rounded-lg">
            <table class="w-full divide-y divide-base">
                <thead class="bg-muted/10">
                <tr>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Group
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Full
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Read
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Adopt
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Forget
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Reconnect
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        ModifyConfig
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Delete
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Update
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-center text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                        Create
                    </th>
                </tr>
                </thead>
                <tbody class="divide-y divide-base">
                {% for permissions, group in permission_matrix %}
                <tr class="bg-table rounded-lg transition-colors">
                    <td class="px-4 py-3 text-sm text-sat-l">
                        <a href="/group/{{ group.id }}">{{ group.name }}</a>
                    </td>
                    {% for perm, checked in permissions %}
                    <td class="px-4 py-3 text-sm text-sat-l text-center">
                        <form
                                hx-post="/probe/{{ probe.id }}/permission/toggle"
                                hx-target="#probe-content-area"
                                hx-target-error="#probe-content-area"
                        >
                            <input
                                    type="checkbox"
                                    class="h-4 w-4 rounded border-base text-acc focus:ring-acc"
                                    {% if checked %}checked{% endif %}
                                    name="value"
                                    value="{% if checked %}true{% else %}false{% endif %}"
                                    onchange="
                this.value = this.checked ? 'true' : 'false';
                this.form.requestSubmit();
            "
                                    aria-label="Toggle permission"
                            />
                            <input type="hidden" name="permission" value="{{ perm }}">
                            <input type="hidden" name="group_id" value="{{ group.id }}">
                        </form>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Probe Configs Table -->
    <div class="overflow-x-auto rounded-lg border border-base bg-cards mt-8 mb-8">
        <div class="flex flex-col justify-center items-center py-4">
            <h2 class="text-3xl font-medium text-sat-xl">Capture Configs</h2>
        </div>

        <table class="min-w-full divide-y divide-base">
            <thead class="bg-muted/10">
            <tr>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Interface
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Filter
                </th>
                <th scope="col"
                    class="px-4 py-3 text-right text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Actions
                </th>
            </tr>
            </thead>
            <tbody class="divide-y divide-base">
            {% for cfg in configs %}
            <tr class="bg-table rounded-lg transition-colors">
                <td class="px-4 py-3 text-sm text-code">
                    <input
                            type="text"
                            name="interface"
                            value="{{ cfg.interface }}"
                            class="w-full rounded-md border border-base bg-background px-2 py-1 font-mono text-sm"
                            form="cfg-form-{{ loop.index0 }}"
                            required
                    />
                </td>
                <td class="px-4 py-3 text-sm text-code">
                    <input
                            type="text"
                            name="filter"
                            value="{% if cfg.filter is not none %}{{ cfg.filter }}{% endif %}"
                            class="w-full rounded-md border border-base bg-background px-2 py-1 font-mono text-sm"
                            form="cfg-form-{{ loop.index0 }}"
                            placeholder="optional"
                    />
                </td>
                <td class="px-4 py-3 text-right">
                    <form id="cfg-form-{{ loop.index0 }}"
                          hx-put="/probe/{{ probe.id }}/config/{{ cfg.id }}"
                          hx-target="#probe-content-area"
                          hx-target-error="#probe-content-area"
                          hx-push-url="/probe/{{ probe.id }}"
                          class="inline-flex">
                        {% if permissions|has_perm("ModifyConfig") %}
                        <button
                                type="submit"
                                class="inline-flex items-center rounded-md bg-background px-3 py-1.5 text-m font-medium text-green-700 bg-green-50 hover:bg-green-200 text-primary hover:bg-muted/10 transition-colors"
                                aria-label="Save config"
                                title="Save"
                        >
                            <i class="fa-solid fa-floppy-disk mr-1.5"></i>
                        </button>
                        <button
                                class="ml-2 inline-flex items-center rounded-md bg-background px-3 py-1.5 text-m font-medium text-red-700 bg-red-50 hover:bg-red-200 transition-colors"
                                type="button"
                                hx-delete="/probe/{{ probe.id }}/config/{{ cfg.id }}"
                                hx-target-error="#probe-content-area"
                                hx-push-url="/probe/{{ probe.id }}"
                                aria-label="Delete config"
                                title="Delete"
                        >
                            <i class="fa-solid fa-trash mr-1.5"></i>
                        </button>
                        {% endif %}
                    </form>
                </td>
            </tr>
            {% endfor %}
            <!-- Add Config Row -->
            {% if permissions | has_perm("ModifyConfig") %}
            <tr class="hover:bg-muted/5 transition-colors">
                <td class="px-4 py-3 text-sm text-code">
                    <input
                            type="text"
                            name="interface"
                            class="w-full rounded-md border border-base bg-background px-2 py-1 font-mono text-sm"
                            form="cfg-create-form"
                            placeholder="e.g. eth0"
                            required
                    />
                </td>

                <td class="px-4 py-3 text-sm text-code">
                    <input
                            type="text"
                            name="filter"
                            class="w-full rounded-md border border-base bg-background px-2 py-1 font-mono text-sm"
                            form="cfg-create-form"
                            placeholder="optional, e.g. port 53"
                    />
                </td>
                <td class="px-4 py-3 text-right">

                    <form id="cfg-create-form"
                          hx-post="/probe/{{ probe.id }}/config"
                          hx-target="#probe-content-area"
                          hx-target-error="#probe-content-area"
                          hx-push-url="/probe/{{ probe.id }}"
                          class="inline-flex">
                        <button
                                type="submit"
                                class="inline-flex items-center rounded-md border border-base bg-background px-3 py-1.5 text-m font-medium text-acc hover:bg-muted/10 transition-colors"
                                aria-label="Add config"
                                title="Add config"
                        >
                            <i class="fa-solid fa-plus mr-1.5"></i>
                            Add config
                        </button>
                    </form>
                </td>
            </tr>
            {% endif %}
            </tbody>
        </table>


        {% if configs|length == 0 %}
        <div class="p-6 text-center text-muted-foreground">
            No probe configs found for this probe.
        </div>
        {% endif %}
    </div>


    <!-- Devices Table -->
    <div class="overflow-x-auto rounded-lg border border-base bg-cards mt-8">
        <div class="flex flex-col justify-center items-center py-4">
            <h2 class="text-3xl font-medium text-sat-xl">Devices</h2>
        </div>

        <table class="min-w-full divide-y divide-base">
            <thead class="bg-muted/10">
            <tr>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    ID
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Name
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    MAC
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    IP
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Port
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs  text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Published
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs  text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Exclusive
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs  text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Proxy
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Discovered At
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs text-sat-l font-medium uppercase tracking-wider text-muted-foreground">
                    Actions
                </th>
            </tr>
            <tr>
                <td class="px-4 py-2"><input type="text" id="filter-id" value="{{ filters.id  | default('') }}"
                                             class="w-full rounded-md border border-base px-2 py-1 text-sm"/></td>
                <td class="px-4 py-2"><input type="text" id="filter-name" value="{{ filters.name  | default('') }}"
                                             class="w-full rounded-md border border-base px-2 py-1 text-sm"/></td>
                <td class="px-4 py-2"><input type="text" id="filter-mac" value="{{ filters.mac   | default('') }}"
                                             class="w-full rounded-md border border-base px-2 py-1 text-sm"/></td>
                <td class="px-4 py-2"><input type="text" id="filter-ip" value="{{ filters.ip    | default('') }}"
                                             class="w-full rounded-md border border-base px-2 py-1 text-sm"/></td>
                <td class="px-4 py-2"><input type="text" id="filter-port" value="{{ filters.port  | default('') }}"
                                             class="w-full rounded-md border border-base px-2 py-1 text-sm"/></td>
                <td class="px-4 py-2">
                    <select id="filter-published" class="w-full rounded-md border border-base px-2 py-1 text-sm">
                        <option value="" {% if filters.published is none %} selected {% endif %}>All</option>
                        <option value="true" {% if filters.published is sameas true %} selected {% endif %}>Published
                        </option>
                        <option value="false" {% if filters.published is sameas false %} selected {% endif %}>Not
                            Published
                        </option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <select id="filter-exclusive" class="w-full rounded-md border border-base px-2 py-1 text-sm">
                        <option value="" {% if filters.exclusive is none %} selected {% endif %}>All</option>
                        <option value="true" {% if filters.exclusive is sameas true %} selected {% endif %}>Exclusive
                        </option>
                        <option value="false" {% if filters.exclusive is sameas false %} selected {% endif %}>Not
                            Exclusive
                        </option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <select id="filter-proxy" class="w-full rounded-md border border-base px-2 py-1 text-sm">
                        <option value="" {% if filters.proxy is none %} selected {% endif %}>All</option>
                        <option value="true" {% if filters.proxy is sameas true %} selected {% endif %}>Proxy
                        </option>
                        <option value="false" {% if filters.proxy is sameas false %} selected {% endif %}>No
                            Proxy
                        </option>
                    </select>
                </td>
                <td class="px-4 py-2"></td>
                <td class="px-4 py-2 flex gap-2">
                    <button type="button" id="filter-button"
                            class="px-3 py-1 rounded-md bg-acc text-sm bg-primary text-button hover:bg-primary/90 transition-colors">
                        Search
                    </button>
                    <button type="button" id="reset-button"
                            class="px-3 py-1 rounded-md text-sm bg-acc-l text-button hover:bg-muted/20 transition-colors">
                        Reset
                    </button>
                </td>
            </tr>
            </thead>
            <tbody class="divide-y divide-base">
            {% for device in devices %}
            <tr class="cursor-pointer rounded-lg bg-table transition-colors" data-href="/device/{{ device.id }}">
                <td class="px-4 py-3 font-mono text-sm text-sat-l">
                    <a href="/device/{{ device.id }}" class="text-primary hover:underline">
                        {{ device.id }}
                    </a>
                </td>
                <td class="px-4 py-3 text-sm text-sat-l">
                    {% if device.name is not none %}
                    {{ device.name }}
                    {% else %}
                    <span class="text-muted-foreground">—</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-sat-l">{{ device.mac }}</td>
                <td class="px-4 py-3 text-sm text-sat-l">{{ device.ip }}</td>
                <td class="px-4 py-3 text-sm text-sat-l">{{ device.port }}</td>
                <td class="px-4 py-3 text-sm">
                    {% if device.published %}
                    <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
                    {% else %}
                    <span class="inline-flex items-center rounded-md bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">No</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm">
                    {% if device.exclusive %}
                    <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
                    {% else %}
                    <span class="inline-flex items-center rounded-md bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">No</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm">
                    {% if device.proxy %}
                    <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
                    {% else %}
                    <span class="inline-flex items-center rounded-md bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">No</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-sat-l">{{ device.discovered_at }}</td>
                {% if permissions|has_perm("Delete") %}
                <td class="px-4 py-3 text-sm text-sat-l">
                    <button
                            hx-delete="/device/{{ device.id }}/delete?return_url=/probe/{{ probe.id }}?page={{ page_info.page }}"
                            hx-target="#probe-content-area"
                            hx-target-error="#probe-content-area"
                            hx-push-url="/probe/{{ probe.id }}?page={{ page_info.page }}"
                            class="inline-flex items-center rounded-md px-3 py-1 text-sm text-red-400 hover:text-red-500 hover:bg-muted/20 transition-colors"
                            title="Delete device"

                    >
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
            </tbody>
        </table>


        {% if devices|length == 0 %}
        <div class="p-6 text-center text-muted-foreground">
            No devices found for this probe.
        </div>
        {% endif %}
    </div>


    {% if page_info.total_pages > 1 %}
    {% set qs = query_string|replace('page=' ~ page_info.page, '') %}
    {% if qs != "" %}
    {% set qs = "&" ~ qs | trim("&") %}
    {% endif %}
    <div class="flex justify-center items-center mt-6 space-x-2">
        {# Previous button #}
        {% if page_info.page > 1 %}
        <button hx-get="/probe/{{ probe.id }}?page={{ page_info.page - 1 }}{{ qs }}"
                hx-target="#probe-content-area"
                hx-target-error="#probe-content-area"
                hx-push-url="/probe/{{ probe.id }}?page={{ page_info.page - 1 }}{{ qs }}"
                class="px-3 py-1 rounded-md border border-base text-acc text-sm hover:bg-muted/20 transition-colors">
            Prev
        </button>
        {% endif %}

        {# Display the first page #}
        {% if page_info.page > 4 %}
        <button hx-get="/probe/{{ probe.id }}?page=1{{ qs }}"
                hx-target="#probe-content-area"
                hx-target-error="#probe-content-area"
                hx-push-url="/probe/{{ probe.id }}?page=1{{ qs }}"
                class="px-3 py-1 rounded-md border border-base text-acc text-sm hover:bg-muted/20 transition-colors">
            1
        </button>
        {% endif %}

        {# Display the '...' if needed #}
        {% if page_info.page > 4 %}
        <span class="px-3 py-1 rounded-md border border-base text-sm">...</span>
        {% endif %}

        {# Numbered pages #}
        {% for p in [page_info.page - 2, page_info.page - 1, page_info.page, page_info.page + 1, page_info.page + 2] %}
        {% if 1 <= p and p <= page_info.total_pages %}
        {% if p == page_info.page %}
        <span class="px-3 py-1 rounded-md bg-primary text-white text-sm">{{ p }}</span>
        {% else %}
        <button hx-get="/probe/{{ probe.id }}?page={{ p }}{{ qs }}"
                hx-target="#probe-content-area"
                hx-target-error="#probe-content-area"
                hx-push-url="/probe/{{ probe.id }}?page={{ p }}{{ qs }}"
                class="px-3 py-1 rounded-md border border-base text-sm text-acc hover:bg-muted/20 transition-colors">
            {{ p }}
        </button>
        {% endif %}
        {% endif %}
        {% endfor %}

        {# Display the '...' if needed #}
        {% if page_info.page < page_info.total_pages - 3 %}
        <span class="px-3 py-1 rounded-md border border-base text-sm">...</span>
        {% endif %}

        {# Display the last page #}
        {% if page_info.page < page_info.total_pages - 2 %}
        <button hx-get="/probe/{{ probe.id }}?page={{ page_info.total_pages }}{{ qs }}"
                hx-target="#probe-content-area"
                hx-target-error="#probe-content-area"
                hx-push-url="/probe/{{ probe.id }}?page={{ page_info.total_pages }}{{ qs }}"
                class="px-3 py-1 rounded-md border border-base text-acc text-sm hover:bg-muted/20 transition-colors">
            {{ page_info.total_pages }}
        </button>
        {% endif %}

        {# Next button #}
        {% if page_info.page < page_info.total_pages %}
        <button hx-get="/probe/{{ probe.id }}?page={{ page_info.page + 1 }}{{ qs }}"
                hx-target="#probe-content-area"
                hx-target-error="#probe-content-area"
                hx-push-url="/probe/{{ probe.id }}?page={{ page_info.page + 1 }}{{ qs }}"
                class="px-3 py-1 rounded-md border border-base text-acc text-sm hover:bg-muted/20 transition-colors">
            Next
        </button>
        {% endif %}
    </div>
    {% endif %}


</div>


<script>

    function filter_probes() {
        let filters = ["id", "name","mac","ip","port", "published", "exclusive", "proxy"];

        function runSearch() {
            const params = new URLSearchParams();

            filters.forEach(field => {
                const value = document.getElementById(`filter-${field}`).value.trim();
                if (value) {
                    params.set(field, value);
                }
            });

            // Reset to first page when filtering
            params.delete("page");

            window.location.search = params.toString();
        }


        // Search button
        document.getElementById("filter-button").addEventListener("click", runSearch);

        // Reset button
        document.getElementById("reset-button").addEventListener("click", () => {
            window.location.href = window.location.pathname;
        });

        // Trigger search on Enter in any filter input
        filters.forEach(field => {
            const input = document.getElementById(`filter-${field}`);
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault(); // prevent form-like submit
                    runSearch();
                }
            });
        });

    }


    function clickOnDevice() {
        document.querySelectorAll("tr[data-href]").forEach(row => {
            row.addEventListener("click", e => {
                if (
                    e.target.closest("a, button, input, textarea") ||
                    window.getSelection().toString().length > 0
                ) {
                    return;
                }
                window.location = row.dataset.href;
            });
        });

    }

    function initEditOwnerButton() {
        const editBtn = document.getElementById("edit-owner-btn");
        if (!editBtn) return;

        editBtn.addEventListener("click", () => {
            const ownerField = document.getElementById("owner-field");
            const probeId = "{{ probe.id }}";

            ownerField.innerHTML = `
          <form method="post" action="/probe/update-owner" class="flex items-center gap-2">
            <input type="hidden" name="id" value="${probeId}">
            <input
              type="number"
              name="owner_id"
              class="rounded-md border border-base bg-panes px-2 py-1 w-24 text-sat-l focus:outline-none focus:ring-2 focus:ring-acc"
              placeholder="ID"
            />
            <button type="submit" title="Save" class="text-xs text-green-600 hover:text-green-800">
              <i class="fa-solid fa-check"></i>
            </button>
          </form>
        `;
        });
    }

    // Run when page initially loads
    document.addEventListener("DOMContentLoaded", initEditOwnerButton);
    document.addEventListener("DOMContentLoaded", clickOnDevice);
    document.addEventListener("DOMContentLoaded", filter_probes);


    // Re-run whenever HTMX swaps content into #probe-content-area
    document.body.addEventListener("htmx:afterSwap", (evt) => {
        if (evt.detail.target.id === "probe-content-area") {
            initEditOwnerButton();
            clickOnDevice();
            filter_probes();
        }
    });


</script>