<!-- create_packet_form.html (MiniJinja) -->
<div class="container mx-auto p-6 max-w-7xl">
    <form id="create-packet-form"
          hx-post="/packet/create"
          hx-target="#content-area"
          hx-push-url="/packet/create"
          hx-target-error="#content-area"
          class="bg-forms shadow-md rounded px-8 pt-6 pb-8 mb-4 space-y-6">
        <h2 class="text-forms text-xl font-bold mb-2 text-center">Create Packet</h2>

        <!-- Hidden probe_id provided by server -->
        <input type="hidden" name="probe_id" value="{{ probe_id }}" />
        <input type="hidden" name="mac" value="{{ mac }}" />
        <input type="hidden" name="ip" value="{{ ip }}" />

        <!-- MACs and IPs -->
        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col">
                <label class="text-xs uppercase tracking-wide text-sat-m">Source MAC</label>
                <input name="src_mac" type="text" value="{{ src_mac or '' }}" required
                       placeholder="AA:BB:CC:DD:EE:FF"
                       class="mt-1 rounded-md border border-base bg-panes px-3 py-2" />
            </div>

            <div class="flex flex-col">
                <label class="text-xs uppercase tracking-wide text-sat-m">Destination MAC</label>
                <input name="dst_mac" type="text" value="{{ dst_mac or '' }}" required
                       placeholder="AA:BB:CC:DD:EE:FF"
                       class="mt-1 rounded-md border border-base bg-panes px-3 py-2" />
            </div>

            <div class="flex flex-col">
                <label class="text-xs uppercase tracking-wide text-sat-m">Source IP (CIDR)</label>
                <input name="src_addr" type="text" value="{{ src_addr or '' }}" required
                       placeholder="192.168.1.10/24"
                       class="mt-1 rounded-md border border-base bg-panes px-3 py-2" />
            </div>

            <div class="flex flex-col">
                <label class="text-xs uppercase tracking-wide text-sat-m">Destination IP (CIDR)</label>
                <input name="dst_addr" type="text" value="{{ dst_addr or '' }}" required
                       placeholder="8.8.8.8/32"
                       class="mt-1 rounded-md border border-base bg-panes px-3 py-2" />
            </div>

            <div class="flex flex-col">
                <label class="text-xs uppercase tracking-wide text-sat-m">Source Port</label>
                <input name="src_port" type="number" min="0" max="65535" value="{{ src_port or 0 }}" required
                       class="mt-1 rounded-md border border-base bg-panes px-3 py-2" />
            </div>

            <div class="flex flex-col">
                <label class="text-xs uppercase tracking-wide text-sat-m">Destination Port</label>
                <input name="dst_port" type="number" min="0" max="65535" value="{{ dst_port or 53 }}" required
                       class="mt-1 rounded-md border border-base bg-panes px-3 py-2" />
            </div>
        </div>

        <!-- DNS Header fields (explicit) -->
        <div class="rounded-lg border border-base bg-cards p-4 space-y-2">
            <h3 class="text-sm font-semibold">DNS Header</h3>

            <div class="grid grid-cols-4 gap-4">
                <div class="flex flex-col">
                    <label class="text-xs uppercase tracking-wide text-sat-m">Response Code</label>
                    <select name="response_code" class="mt-1 rounded-md border px-2 py-1">
                        <!-- only common codes; adjust as needed -->
                        <option value="0" selected>NoError (0)</option>
                        <option value="1">FormErr (1)</option>
                        <option value="2">ServFail (2)</option>
                        <option value="3">NXDomain (3)</option>
                        <option value="4">NotImp (4)</option>
                        <option value="5">Refused (5)</option>
                    </select>
                </div>

                <div class="flex flex-col">
                    <label class="text-xs uppercase tracking-wide text-sat-m">Query Count</label>
                    <input name="query_count" type="number" min="0" value="{{ queries|length or 0 }}"
                           class="mt-1 rounded-md border px-2 py-1" />
                </div>

                <div class="flex flex-col">
                    <label class="text-xs uppercase tracking-wide text-sat-m">Answer Count</label>
                    <input name="answer_count" type="number" min="0" value="{{ answers|length or 0 }}"
                           class="mt-1 rounded-md border px-2 py-1" />
                </div>

                <div class="flex flex-col">
                    <label class="text-xs uppercase tracking-wide text-sat-m">Authority Count</label>
                    <input name="name_server_count" type="number" min="0" value="{{ name_servers|length or 0 }}"
                           class="mt-1 rounded-md border px-2 py-1" />
                </div>

                <div class="flex flex-col">
                    <label class="text-xs uppercase tracking-wide text-sat-m">Additional Count</label>
                    <input name="additional_count" type="number" min="0" value="{{ additionals|length or 0 }}"
                           class="mt-1 rounded-md border px-2 py-1" />
                </div>
            </div>
        </div>

        <!-- Queries: repeatable -->
        <div id="queries-section" class="space-y-2">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold">Queries</h3>
                <div class="space-x-2">
                    <!-- HTMX + fallback template approach -->
                    <button
                            type="button"
                            hx-get="/packet/fragments/query"
                            hx-target="#queries-section"
                            hx-swap="afterend"
                            class="px-2 py-1 text-xs bg-acc rounded">Add Query (server)</button>

                    <button type="button" onclick="cloneTemplate('query-template')"
                            class="px-2 py-1 text-xs bg-acc rounded">Add Query (client)</button>
                </div>
            </div>

            {% if queries %}
            {% for q in queries %}
            <div class="query-row border rounded p-3 bg-white">
                <input type="hidden" name="queries[{{ loop.index0 }}][__keep]" value="1" />
                <div class="grid grid-cols-3 gap-2">
                    <input name="queries[{{ loop.index0 }}][name]" value="{{ q.name }}" placeholder="example.com." required
                           class="rounded border px-2 py-1" />
                    <input name="queries[{{ loop.index0 }}][query_type]" value="{{ q.query_type }}" placeholder="A" required
                           class="rounded border px-2 py-1" />
                    <input name="queries[{{ loop.index0 }}][query_class]" value="{{ q.query_class }}" placeholder="IN" required
                           class="rounded border px-2 py-1" />
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- empty initial -->
            {% endif %}
        </div>

        <!-- Records sections (answers / authority / additionals) -->
        {% for slot in ["answers","name_servers","additionals"] %}
        <div id="{{ slot }}-section" class="space-y-2">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold">{{ slot|replace("_"," ") | title }}</h3>
                <div class="space-x-2">
                    <button
                            type="button"
                            hx-get="/packet/fragments/record?slot={{ slot }}"
                            hx-target="#{{ slot }}-section"
                            hx-swap="afterend"
                            class="px-2 py-1 text-xs bg-acc rounded">Add Record (server)</button>

                    <button type="button" onclick="cloneTemplate('record-template-{{ slot }}')" class="px-2 py-1 text-xs bg-acc rounded">Add Record (client)</button>
                </div>
            </div>

            {% if (slot == "answers" and answers) or (slot == "name_servers" and name_servers) or (slot == "additionals" and additionals) %}
            {% set list = slot == "answers" and answers or slot == "name_servers" and name_servers or additionals %}
            {% for r in list %}
            <div class="record-row border rounded p-3 bg-white">
                <input type="hidden" name="{{ slot }}[{{ loop.index0 }}][__keep]" value="1" />
                <div class="grid grid-cols-4 gap-2">
                    <input name="{{ slot }}[{{ loop.index0 }}][name]" value="{{ r.name }}" placeholder="example.com." required class="rounded border px-2 py-1" />
                    <input name="{{ slot }}[{{ loop.index0 }}][record_type]" value="{{ r.record_type }}" placeholder="A" required class="rounded border px-2 py-1" />
                    <input name="{{ slot }}[{{ loop.index0 }}][dns_class]" value="{{ r.dns_class or 'IN' }}" placeholder="IN" required class="rounded border px-2 py-1" />
                    <input name="{{ slot }}[{{ loop.index0 }}][ttl]" type="number" value="{{ r.ttl or 300 }}" placeholder="TTL" class="rounded border px-2 py-1" />
                    <input name="{{ slot }}[{{ loop.index0 }}][rdata]" value="{{ r.rdata }}" placeholder="RDATA (depends on type e.g. 1.2.3.4 or 'text string')" class="rounded border px-2 py-1 col-span-4 mt-2" />
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        {% endfor %}

        <div class="flex justify-end">
            <button type="submit"
                    class="bg-acc text-button font-bold py-2 px-6 rounded-lg focus:outline-none hover:scale-105 transition-all duration-200">
                Send Packet
            </button>
        </div>
    </form>
</div>

<!-- Client-side templates for cloning (fallback if you don't want server fragments) -->
<template id="query-template">
    <div class="query-row border rounded p-3 bg-white mt-2">
        <div class="grid grid-cols-3 gap-2">
            <input name="queries[][name]" placeholder="example.com." required class="rounded border px-2 py-1" />
            <input name="queries[][query_type]" placeholder="A" required class="rounded border px-2 py-1" />
            <input name="queries[][query_class]" placeholder="IN" required class="rounded border px-2 py-1" />
        </div>
    </div>
</template>

<template id="record-template-answers">
    <div class="record-row border rounded p-3 bg-white mt-2">
        <div class="grid grid-cols-4 gap-2">
            <input name="answers[][name]" placeholder="example.com." required class="rounded border px-2 py-1" />
            <input name="answers[][record_type]" placeholder="A" required class="rounded border px-2 py-1" />
            <input name="answers[][dns_class]" placeholder="IN" required class="rounded border px-2 py-1" />
            <input name="answers[][ttl]" type="number" placeholder="300" class="rounded border px-2 py-1" />
            <input name="answers[][rdata]" placeholder="1.2.3.4 or 'text string' etc." class="rounded border px-2 py-1 col-span-4 mt-2" />
        </div>
    </div>
</template>

<!-- record-template-name_servers and record-template-additionals can reuse the above with adjusted name attributes -->
<template id="record-template-name_servers">
    <!-- clone but name= name_servers[][... ] -->
    <div class="record-row border rounded p-3 bg-white mt-2">
        <div class="grid grid-cols-4 gap-2">
            <input name="name_servers[][name]" placeholder="example.com." required class="rounded border px-2 py-1" />
            <input name="name_servers[][record_type]" placeholder="NS" required class="rounded border px-2 py-1" />
            <input name="name_servers[][dns_class]" placeholder="IN" required class="rounded border px-2 py-1" />
            <input name="name_servers[][ttl]" type="number" placeholder="300" class="rounded border px-2 py-1" />
            <input name="name_servers[][rdata]" placeholder="ns1.example.com." class="rounded border px-2 py-1 col-span-4 mt-2" />
        </div>
    </div>
</template>

<template id="record-template-additionals">
    <div class="record-row border rounded p-3 bg-white mt-2">
        <div class="grid grid-cols-4 gap-2">
            <input name="additionals[][name]" placeholder="example.com." required class="rounded border px-2 py-1" />
            <input name="additionals[][record_type]" placeholder="A" required class="rounded border px-2 py-1" />
            <input name="additionals[][dns_class]" placeholder="IN" required class="rounded border px-2 py-1" />
            <input name="additionals[][ttl]" type="number" placeholder="300" class="rounded border px-2 py-1" />
            <input name="additionals[][rdata]" placeholder="1.2.3.4 or text" class="rounded border px-2 py-1 col-span-4 mt-2" />
        </div>
    </div>
</template>

<script>
    function cloneTemplate(id) {
        const t = document.getElementById(id);
        if (!t) return;
        const clone = t.content.cloneNode(true);
        // Append after the element indicated by id
        if (id === 'query-template') {
            document.getElementById('queries-section').appendChild(clone);
        } else if (id.startsWith('record-template')) {
            const slot = id.split('-').pop(); // answers, name_servers, additionals
            document.getElementById(slot + '-section').appendChild(clone);
        }
    }
</script>
