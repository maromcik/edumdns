<div class="max-w-7xl mx-auto px-4 sm:px-8">
    <form id="create-packet-json-form"
          action="/packet/create"
          method="post"
          class="space-y-6 bg-forms shadow-md rounded px-8 pt-6 pb-8">

        <h2 class="text-xl font-bold text-center mb-4">Create Packet (JSON)</h2>

        <!-- Hidden fields provided by server -->
        <input type="hidden" name="probe_id" id="probe_id" value="{{ probe_id }}" />
        <input type="hidden" name="src_mac" id="src_mac" value="{{ mac }}" />
        <input type="hidden" name="src_addr" id="src_addr" value="{{ ip }}" />
        <input type="hidden" name="dst_port" id="dst_port" value="{{ port }}" />

        <!-- Metadata preview -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs uppercase mb-1">Probe ID</label>
                <div class="p-2 rounded border bg-forms break-all">
                    <code class="text-forms-input">{{ probe_id }}</code>
                </div>
            </div>
            <div>
                <label class="block text-xs uppercase mb-1">Source MAC</label>
                <div class="p-2 rounded border bg-forms break-all">
                    <code class="text-forms-input">{{ mac }}</code>
                </div>
            </div>
            <div>
                <label class="block text-xs uppercase mb-1">Source IP</label>
                <div class="p-2 rounded border bg-forms break-all">
                    <code class="text-forms-input">{{ ip }}</code>
                </div>
            </div>
            <div>
                <label class="block text-xs uppercase mb-1">Dest Port</label>
                <div class="p-2 rounded border bg-forms break-all">
                    <code class="text-forms-input">{{ port }}</code>
                </div>
            </div>
        </div>

        <!-- Header -->
        <fieldset class="border rounded p-4">
            <legend class="text-sm font-semibold">DNS Header</legend>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs uppercase mb-1">Message Type</label>
                    <select id="header-message_type" class="w-full rounded border px-2 py-1">
                        <option value="Query" selected>Query</option>
                        <option value="Response">Response</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase mb-1">Op Code</label>
                    <select id="header-op_code" class="w-full rounded border px-2 py-1">
                        <option value="Query" selected>Query</option>
                        <option value="IQuery">IQuery</option>
                        <option value="Status">Status</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase mb-1">Response Code</label>
                    <select id="header-response_code" class="w-full rounded border px-2 py-1">
                        <option value="NoError" selected>NoError</option>
                        <option value="FormErr">FormErr</option>
                        <option value="ServFail">ServFail</option>
                        <option value="NXDomain">NXDomain</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase mb-1">ID</label>
                    <input id="header-id" type="number" min="0" max="65535" value="0"
                           class="w-full rounded border px-2 py-1" />
                </div>
            </div>
        </fieldset>

        <!-- Queries -->
        <fieldset class="border rounded p-4">
            <legend class="text-sm font-semibold">Queries</legend>
            <div id="queries-list" class="space-y-3">
                <div class="query-row border rounded p-3 bg-white flex gap-2 items-center">
                    <input type="text" placeholder="name (example.com.)"
                           class="query-name flex-1 rounded border px-2 py-1" />
                    <select class="query-type w-24 rounded border px-2 py-1">
                        <option value="A" selected>A</option>
                        <option value="AAAA">AAAA</option>
                        <option value="ANY">ANY</option>
                        <option value="CNAME">CNAME</option>
                        <option value="MX">MX</option>
                        <option value="TXT">TXT</option>
                        <option value="PTR">PTR</option>
                    </select>
                    <input type="text" placeholder="class (IN)"
                           class="query-class w-20 rounded border px-2 py-1" value="IN" />
                    <button type="button"
                            class="text-xs px-2 py-1 bg-red-500 text-button rounded"
                            onclick="removeRow(this)">Del</button>
                </div>
            </div>
            <div class="mt-2 flex gap-2">
                <button type="button" id="add-query-btn" class="bg-acc text-button px-3 py-1 rounded">+ Query</button>
                <button type="button" id="clear-queries-btn" class="px-3 py-1 rounded border">Clear</button>
            </div>
        </fieldset>

        <!-- Answers -->
        <fieldset class="border rounded p-4">
            <legend class="text-sm font-semibold">Answers</legend>
            <div id="answers-list" class="space-y-3"></div>
            <div class="mt-2 flex gap-2">
                <button type="button" id="add-answer-btn" class="bg-acc text-button px-3 py-1 rounded">+ Answer</button>
            </div>
        </fieldset>

        <div class="flex justify-end gap-3">
            <button id="preview-json-btn" type="button" class="px-4 py-2 rounded border">Preview JSON</button>
            <button type="submit"
                    class="bg-acc hover:bg-acc-l text-button px-6 py-2 rounded shadow">
                Send Packet
            </button>
        </div>
    </form>

    <pre id="json-preview"
         class="hidden mt-4 p-3 bg-black text-button rounded overflow-auto"
         style="max-height:40vh"></pre>
</div>

<script>
    function removeRow(btn){ btn.closest('div').remove(); }

    // Add query row
    document.getElementById('add-query-btn').addEventListener('click', () => {
        const row = document.createElement('div');
        row.className = "query-row border rounded p-3 bg-white flex gap-2 items-center";
        row.innerHTML = `
          <input type="text" placeholder="name (example.com.)"
                 class="query-name flex-1 rounded border px-2 py-1" />
          <select class="query-type w-24 rounded border px-2 py-1">
            <option value="A" selected>A</option>
            <option value="AAAA">AAAA</option>
            <option value="ANY">ANY</option>
            <option value="CNAME">CNAME</option>
            <option value="MX">MX</option>
            <option value="TXT">TXT</option>
            <option value="PTR">PTR</option>
          </select>
          <input type="text" placeholder="class (IN)"
                 class="query-class w-20 rounded border px-2 py-1" value="IN" />
          <button type="button" class="text-xs px-2 py-1 bg-red-500 text-button rounded"
                  onclick="removeRow(this)">Del</button>`;
        document.getElementById('queries-list').appendChild(row);
    });

    document.getElementById('clear-queries-btn').addEventListener('click', () => {
        document.getElementById('queries-list').innerHTML = '';
    });

    // Add answer row
    document.getElementById('add-answer-btn').addEventListener('click', () => {
        const row = document.createElement('div');
        row.className = "answer-row border rounded p-3 bg-white grid grid-cols-6 gap-2 items-center";
        row.innerHTML = `
          <input type="text" placeholder="name_labels (example.com.)" class="answer-name col-span-2 rounded border px-2 py-1" />
          <input type="text" placeholder="class (IN)" class="answer-class w-20 rounded border px-2 py-1" value="IN" />
          <input type="number" placeholder="ttl" class="answer-ttl w-24 rounded border px-2 py-1" value="300" />
          <select class="answer-type w-24 rounded border px-2 py-1">
            <option value="A">A</option>
            <option value="AAAA">AAAA</option>
            <option value="CNAME">CNAME</option>
            <option value="MX">MX</option>
            <option value="TXT">TXT</option>
            <option value="PTR">PTR</option>
          </select>
          <input type="text" placeholder="rdata (e.g. 1.2.3.4, text, or ptr target)" class="answer-rdata col-span-6 rounded border px-2 py-1 mt-2" />
          <div class="col-span-6 mt-2 flex justify-end">
            <button type="button" class="text-xs px-2 py-1 bg-red-500 text-button rounded"">Del</button>
          </div>`;
        document.getElementById('answers-list').appendChild(row);
    });

    document.getElementById('answers-list').addEventListener('click', function(e) {
        if(e.target.tagName === 'BUTTON' && e.target.textContent === 'Del'){
            const row = e.target.closest('.answer-row');
            if(row) row.remove();
        }
    });
    function buildCreatePacketJson(){
        const probe_id = document.getElementById('probe_id').value;
        const src_mac = document.getElementById('src_mac').value;
        const src_addr = document.getElementById('src_addr').value;
        const dst_port = Number(document.getElementById('dst_port')?.value || 0);

        // header
        const header = {
            id: Number(document.getElementById('header-id').value || 0),
            message_type: document.getElementById('header-message_type').value || "Query",
            op_code: document.getElementById('header-op_code').value || "Query",
            authoritative: false,
            truncation: false,
            recursion_desired: false,
            recursion_available: false,
            authentic_data: false,
            checking_disabled: false,
            response_code: document.getElementById('header-response_code').value || "NoError",
            query_count: 0, answer_count: 0, name_server_count: 0, additional_count: 0
        };

        // queries
        const queries = [];
        document.querySelectorAll('#queries-list .query-row').forEach(row => {
            const name = row.querySelector('.query-name')?.value?.trim() || "";
            const qtype = row.querySelector('.query-type')?.value || "A";
            const qclass = row.querySelector('.query-class')?.value?.trim() || "IN";
            if(name) queries.push({ name, query_type: qtype, query_class: qclass, mdns_unicast_response: true });
        });

        // answers
        const answers = [];
        document.querySelectorAll('#answers-list .answer-row').forEach(row => {
            const name_labels = row.querySelector('.answer-name')?.value?.trim() || "";
            const dns_class = row.querySelector('.answer-class')?.value?.trim() || "IN";
            const ttl = Number(row.querySelector('.answer-ttl')?.value || 300);
            const type = row.querySelector('.answer-type')?.value || "A";
            const rdataVal = row.querySelector('.answer-rdata')?.value?.trim() || "";
            if(name_labels && rdataVal){
                let rdata;
                if (type === "TXT") {
                    rdata = { TXT: [rdataVal] }; // TXT must be array of strings
                } else {
                    rdata = { [type]: rdataVal };
                }
                answers.push({ name_labels, dns_class, ttl, rdata, mdns_cache_flush: false });
            }
        });

        return {
            probe_id, src_mac, src_addr, dst_port,
            message: {
                header, queries, answers,
                name_servers: [], additionals: [], signature: [], edns: null
            }
        };
    }

    // Preview JSON
    document.getElementById('preview-json-btn').addEventListener('click', () => {
        const obj = buildCreatePacketJson();
        const pre = document.getElementById('json-preview');
        pre.textContent = JSON.stringify(obj, null, 2);
        pre.classList.toggle('hidden');
    });

    // Submit override
    document.getElementById('create-packet-json-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const payload = buildCreatePacketJson();
        fetch(e.target.action, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
            .then(resp => {
                if (resp.redirected) {
                    window.location.href = resp.url;
                } else {
                    window.location.reload();
                }
            })
            .catch(err => console.error('submit error', err));
    });
</script>
