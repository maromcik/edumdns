{% extends "index/page.html" %}

{% block content %}
{% include "probe/detail/content.html"%}
<script>
    console.log("Connecting to WebSocket...");
    if (!window.probeWs) {
        window.probeWs = new WebSocket(`ws://${location.host}/probe/{{ probe.id }}/ws`);
        window.probeWs.onmessage = (event) => {
            console.log("Update:", event.data);

            // Determine success/error from payload
            const msg = event.data;
            const isError = msg.startsWith("Error:");
            showNotification(msg, isError ? "error" : "success");
        };
    }
    window.addEventListener("beforeunload", () => {
        if (window.probeWs) {
            window.probeWs.close();
            window.probeWs = null;
        }
    });

    function showNotification(message, type) {
        const container = document.getElementById("notifications");

        const notif = document.createElement("div");
        notif.className = `notification ${type} hidden`;
        notif.textContent = message;

        container.appendChild(notif);

        // Let the DOM paint, then fade in
        requestAnimationFrame(() => {
            notif.classList.remove("hidden");
            notif.classList.add("show");
        });

        // Keep visible for 10s
        const lifetime = 10000;
        setTimeout(() => {
            notif.classList.remove("show");
            notif.classList.add("hide");

            notif.addEventListener("transitionend", () => notif.remove(), { once: true });
        }, lifetime);
    }


</script>
{% endblock %}

