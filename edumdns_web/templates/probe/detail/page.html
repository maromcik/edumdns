{% extends "index/page.html" %}

{% block content %}
<div id="probe-content-area" class="max-w-7xl mx-auto mb-10 md:mb-5">
    {% include "probe/detail/content.html"%}
</div>
<div id="notifications" class="fixed bottom-4 right-4 flex flex-col gap-2 z-50"></div>
<script>
    const locationProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${locationProtocol}://${location.host}/probe/{{ probe.id }}/ws`;

    function connectWebSocket() {
        if (window.probeWs && window.probeWs.readyState === WebSocket.OPEN) {
            return; // Already connected
        }

        console.log(`Connecting to WebSocket ${wsUrl}`);
        const ws = new WebSocket(wsUrl);
        window.probeWs = ws;

        ws.onopen = () => {
            console.log("WebSocket connected");
        };

        ws.onmessage = (event) => {
            let data = event.data;
            console.log("Update:", data);
            // Normalize booleans
            if (data === "true" || data === "false") {
                const isAlive = data === "true";
                updateProbeStatusDot(isAlive);
                return;
            }

            // Fallback: notifications for errors/other events
            const isError = data.startsWith("Error:");
            showNotification(data, isError ? "error" : "success");
        };

        ws.onclose = () => {
            console.warn("WebSocket closed, retrying...");
            // Retry after delay
            setTimeout(connectWebSocket, 2000);
        };

        ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            ws.close(); // Will trigger onclose → reconnect
        };
    }

    // Reconnect when page becomes visible again (unlock, tab focus, back nav)
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            connectWebSocket();
        }
    });

    window.addEventListener("beforeunload", () => {
        if (window.probeWs) {
            window.probeWs.onclose = null; // Don’t trigger reconnect on unload
            window.probeWs.close();
            window.probeWs = null;
        }
    });

    function showNotification(message, type) {
        const container = document.getElementById("notifications");

        const notif = document.createElement("div");
        notif.className = `notification ${type} hidden`;
        notif.textContent = message;

        container.appendChild(notif);

        requestAnimationFrame(() => {
            notif.classList.remove("hidden");
            notif.classList.add("show");
        });

        const lifetime = 10000;
        setTimeout(() => {
            notif.classList.remove("show");
            notif.classList.add("hide");
            notif.addEventListener("transitionend", () => notif.remove(), { once: true });
        }, lifetime);
    }

    function updateProbeStatusDot(isAlive) {
        const dot = document.getElementById("probe-status-dot");
        if (!dot) return;

        if (isAlive) {
            dot.classList.remove("bg-red-500", "bg-gray-400");
            dot.classList.add("bg-green-500");
        } else {
            dot.classList.remove("bg-green-500", "bg-gray-400");
            dot.classList.add("bg-red-500");
        }
    }

    // Initial connect
    connectWebSocket();
</script>
{% endblock %}